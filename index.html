<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma MED8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* Cores Base */
            --primary-blue: #003366; 
            --header-green: #1b7340; 
            --border-color: #b0bec5; 
            --body-bg: #f4f6f8; 
            --card-bg: #ffffff; 
            
            /* Textos */
            --text-main: #1a202c;
            --text-secondary: #455a64; 
            --text-header: #212121;
            --bg-header-btn: #ffffff;

            /* Mat√©rias */
            --bg-giesc: #f1f8e9; 
            --bg-hp8: rgba(0, 86, 179, 0.05); 
            --bg-tutorial: #fdf2ff; 
            --bg-morfo: #f3e5f5; 
            
            /* Barras Laterais */
            --bar-hp8: #1565c0;
            --bar-giesc: #2e7d32;
            --bar-tutorial: #7b1fa2;
            --bar-morfo: #4a148c;

            /* Pills (Light Mode) */
            --c-hms: #ef6c00; --c-uepa: #00897b; --c-hrba: #283593; 
            --c-ures: #d81b60; --c-ubs: #558b2f; --c-amb: #00acc1; --c-neutral: #757575;

            /* Time Badge Light */
            --bg-time: #ffebee; --text-time: #c62828; --border-time: #ffcdd2;

            --neon-color: #00bcd4;
            --w-seg: 115px; --w-ter: 115px; --w-qua: 115px; --w-qui: 155px; --w-sex: 115px; --w-sab: 100px;
        }

        /* --- MODO ESCURO --- */
        body.dark-theme {
            --body-bg: #121212; --card-bg: #1e1e1e; 
            --border-color: #546e7a; 
            --primary-blue: #90caf9;
            
            /* Textos */
            --text-main: #eceff1;      
            --text-secondary: #eeeeee; 
            --text-header: #ffffff;
            --bg-header-btn: #263238;
            
            /* Mat√©rias */
            --bg-hp8: rgba(13, 39, 68, 0.6);
            --bg-giesc: #1b3320; --bg-tutorial: #2a1b2e; --bg-morfo: #1f1a24;
            
            /* Barras Laterais */
            --bar-hp8: #42a5f5; --bar-giesc: #66bb6a; --bar-tutorial: #ab47bc; --bar-morfo: #7e57c2;

            /* Pills Dark (Outline Colors) */
            --c-hms: #ffb74d; --c-uepa: #64ffda; --c-hrba: #448aff; 
            --c-ures: #ff80ab; --c-ubs: #b2ff59; --c-amb: #84ffff;

            /* Time Badge Dark */
            --bg-time: #3e2723; --text-time: #ff8a80; --border-time: #5d4037;
            
            --neon-color: #00f2ff;
        }

        /* TRANSI√á√ÉO SUAVE (M√ÅGICA VISUAL) */
        body, .subject-block, .btn-action, .filter-btn, .pill, .main-header, th, td, .members-info, .badge-time {
            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease;
        }

        body { font-family: 'Segoe UI', sans-serif; background-color: var(--body-bg); color: var(--text-main); display: flex; flex-direction: column; align-items: center; padding: 10px; }
        
        /* Remove transi√ß√£o durante o print para n√£o bugar */
        body.capturing * { animation: none !important; transition: none !important; }
        body.capturing .today-column { box-shadow: none !important; border-color: var(--primary-blue) !important; }

        .controls-panel { width: 100%; max-width: 1250px; background: var(--card-bg); padding: 10px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .control-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: space-between; }
        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; }
        
        select, .filter-btn { 
            padding: 4px 10px; border: 1px solid var(--border-color); border-radius: 6px; 
            cursor: pointer; background: var(--bg-header-btn); font-weight: 700; font-size: 0.75rem; 
            color: var(--text-header); 
        }
        .filter-btn:hover { opacity: 0.8; }
        .filter-btn.active { background: #003366; color: white; border-color: #003366; }
        body.dark-theme .filter-btn.active { background: #64b5f6; color: #000; border-color: #64b5f6; }
        .filter-btn.special { background: #fff8e1; border-color: #ffb300; color: #ef6c00; }
        body.dark-theme .filter-btn.special { background: #3e2723; border-color: #ff6f00; color: #ffca28; }
        body.dark-theme .filter-btn.special.active { 
            background: #ff6f00 !important; color: #fff !important; border-color: #ffca28 !important;
            box-shadow: 0 0 10px rgba(255, 111, 0, 0.6);
        }

        .today-label { font-size: 0.75rem; font-weight: bold; color: #003366; background: #e3f2fd; padding: 4px 12px; border-radius: 6px; border: 1px solid #90caf9; }
        body.dark-theme .today-label { background: #1a237e; color: #c5cae9; border: 1px solid #3949ab; }
        
        .members-info { 
            font-size: 0.72rem; font-weight: 600; background: #fffde7; 
            padding: 6px 10px; border-radius: 8px; border: 1px solid #fdd835; 
            margin-top: 8px; line-height: 1.4; width: 100%; box-sizing: border-box; color: #37474f; 
        }
        body.dark-theme .members-info { background: #2a1c0a; color: #ffe0b2; border-color: #b78c00; }

        .schedule-container { width: fit-content; max-content; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow-x: auto; padding: 2px; }
        .main-header { background-color: #003366; color: white; text-align: center; padding: 6px; border-radius: 6px 6px 0 0; }
        .main-header h1 { margin: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        table { width: max-content; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
        th { background-color: var(--header-green); color: white; text-transform: uppercase; font-size: 0.65rem; padding: 6px; border-right: 1px solid rgba(255,255,255,0.1); }
        th:last-child { border-right: none; }
        td { border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); vertical-align: top; padding: 4px; font-size: 0.72rem; position: relative; }
        tr:last-child td { border-bottom: none; }
        
        .today-column { box-shadow: inset 0 0 15px var(--neon-color), 0 0 5px var(--neon-color) !important; z-index: 10; border-color: var(--neon-color) !important; }

        .col-seg { width: var(--w-seg); } .col-ter { width: var(--w-ter); } .col-qua { width: var(--w-qua); } .col-qui { width: var(--w-qui); } .col-sex { width: var(--w-sex); } .col-sab { width: var(--w-sab); }
        .time-col { background-color: #003366; color: white; width: 40px; text-align: center; font-weight: bold; vertical-align: middle; border-bottom: 1px solid rgba(255,255,255,0.1); }

        @keyframes blockEnter { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .subject-block { 
            padding: 6px 8px 6px 12px; border-radius: 10px; margin-bottom: 4px; position: relative; 
            overflow: hidden; animation: blockEnter 0.6s ease-out forwards;
            background-color: var(--bg-hp8); box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03);
        }
        
        .subject-block::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: var(--bar-color);
        }

        .giesc { background-color: var(--bg-giesc) !important; --bar-color: var(--bar-giesc); }
        .hp8 { background-color: var(--bg-hp8) !important; --bar-color: var(--bar-hp8); }
        .tutorial { background-color: var(--bg-tutorial) !important; --bar-color: var(--bar-tutorial); }
        .morfo { background-color: var(--bg-morfo) !important; --bar-color: var(--bar-morfo); }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; gap: 5px; }
        .card-title { font-weight: 700; color: var(--text-main); font-size: 0.78rem; line-height: 1.2; }
        
        /* PILL DESIGN */
        .pill { 
            font-size: 0.55rem; font-weight: 700; padding: 2px 7px; border-radius: 10px; 
            text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0;
            color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.15); border: 1px solid transparent; 
        }

        body.dark-theme .pill { background-color: transparent !important; box-shadow: none; }

        .pill-hms { background: var(--c-hms); }
        body.dark-theme .pill-hms { color: var(--c-hms); border-color: var(--c-hms); }

        .pill-uepa { background: var(--c-uepa); }
        body.dark-theme .pill-uepa { color: var(--c-uepa); border-color: var(--c-uepa); }

        .pill-hrba { background: var(--c-hrba); }
        body.dark-theme .pill-hrba { 
            color: var(--c-hrba); border-color: var(--c-hrba);
            box-shadow: 0 0 6px rgba(68, 138, 255, 0.3) !important; 
        }

        .pill-ures { background: var(--c-ures); }
        body.dark-theme .pill-ures { color: var(--c-ures); border-color: var(--c-ures); }

        .pill-ubs { background: var(--c-ubs); }
        body.dark-theme .pill-ubs { color: var(--c-ubs); border-color: var(--c-ubs); }

        .pill-amb { background: var(--c-amb); }
        body.dark-theme .pill-amb { color: var(--c-amb); border-color: var(--c-amb); }

        .pill-neutral { background: var(--c-neutral); }
        body.dark-theme .pill-neutral { color: var(--c-neutral); border-color: var(--c-neutral); }

        .date-line { display: block; font-size: 0.65rem; color: var(--text-secondary); margin-top: 4px; line-height: 1.5; font-weight: 500; }
        
        /* TIME BADGE STYLE */
        .badge-time {
            display: inline-block;
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 0.58rem;
            font-weight: 700;
            margin-left: 4px;
            vertical-align: middle;
            background-color: var(--bg-time);
            color: var(--text-time);
            border: 1px solid var(--border-time);
        }

        .bottom-container { width: 100%; max-width: 1250px; margin-top: 10px; }
        .bottom-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-action { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; font-size: 1.1rem; background: var(--card-bg); color: var(--text-main); transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-action:hover { transform: translateY(-2px); }
        
        .slider-drawer { display: none; background: var(--card-bg); padding: 12px; border-radius: 12px; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); margin-top: 10px; border: 1px solid var(--border-color); }
        .slider-drawer.active { display: block; }
        .slider-group { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
        .slider-item { display: flex; flex-direction: column; font-size: 0.65rem; font-weight: bold; color: var(--text-secondary); width: 90px; }
    </style>
</head>
<body>

<div class="controls-panel">
    <div class="control-row">
        <div class="btn-group">
            <select id="groupSelect" onchange="changeGroup(this.value)"></select>
            <span id="todayDisplay" class="today-label"></span>
        </div>
        <div class="btn-group">
            <button class="filter-btn" id="btn-all" onclick="setFilter('all', this)">Semestre</button>
            <button class="filter-btn special" id="btn-currWeek" onclick="setFilter('currWeek', this)">Semana Atual</button>
            <button class="filter-btn special" id="btn-nextWeek" onclick="setFilter('nextWeek', this)">Pr√≥xima Semana</button>
        </div>
        <div id="monthButtons" class="btn-group"></div>
    </div>
    <div id="membersDisplay" class="members-info"></div>
</div>

<div id="capture-area" class="schedule-container">
    <div class="main-header"><h1 id="tableTitle">MED8 | 2026.1</h1></div>
    <table>
        <thead>
            <tr id="header-row">
                <th style="width: 40px;">-</th>
                <th class="col-seg" data-day="1">Segunda</th>
                <th class="col-ter" data-day="2">Ter√ßa</th>
                <th class="col-qua" data-day="3">Quarta</th>
                <th class="col-qui" data-day="4">Quinta</th>
                <th class="col-sex" data-day="5">Sexta</th>
                <th class="col-sab" data-day="6">S√°bado</th>
            </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>
</div>

<div class="bottom-container">
    <div class="bottom-actions">
        <button class="btn-action" title="Tema" onclick="toggleDarkMode()">üåì</button>
        <button class="btn-action" title="Horas" onclick="toggleHours()">‚è∞</button>
        <button class="btn-action" title="Colunas" onclick="toggleSliders()">üìè</button>
        <button class="btn-action" title="Print" onclick="generateImage()" style="background: var(--header-green); color: white; border: none;">üñºÔ∏è</button>
    </div>
    <div id="sliderDrawer" class="slider-drawer">
        <div class="slider-group">
            <div class="slider-item">Seg <input type="range" min="40" max="400" value="115" oninput="document.documentElement.style.setProperty('--w-seg', this.value+'px')"></div>
            <div class="slider-item">Ter <input type="range" min="40" max="400" value="115" oninput="document.documentElement.style.setProperty('--w-ter', this.value+'px')"></div>
            <div class="slider-item">Qua <input type="range" min="40" max="400" value="115" oninput="document.documentElement.style.setProperty('--w-qua', this.value+'px')"></div>
            <div class="slider-item">Qui <input type="range" min="40" max="600" value="155" oninput="document.documentElement.style.setProperty('--w-qui', this.value+'px')"></div>
            <div class="slider-item">Sex <input type="range" min="40" max="400" value="115" oninput="document.documentElement.style.setProperty('--w-sex', this.value+'px')"></div>
            <div class="slider-item">S√°b <input type="range" min="40" max="300" value="100" oninput="document.documentElement.style.setProperty('--w-sab', this.value+'px')"></div>
        </div>
    </div>
</div>

<script>
const ANO_LETIVO = 2026;
let showHours = false;

// üß© LEGO DATABASE
const DATA_LEGO = [
    { d: "Segunda", t: "Manh√£", act: "HP-8", p: "Paulo Pires", l: "URES", g: "A", dates: "23/02, 23/03, 20/04, 18/05, 15/06" },
    { d: "Segunda", t: "Manh√£", act: "HP-8", p: "Paulo Pires", l: "URES", g: "B", dates: "02/03, 30/03, 27/04, 25/05, 22/06" },
    { d: "Segunda", t: "Manh√£", act: "HP-8", p: "Paulo Pires", l: "URES", g: "C", dates: "09/03, 06/04, 04/05, 01/06" },
    { d: "Segunda", t: "Manh√£", act: "HP-8", p: "Paulo Pires", l: "URES", g: "D", dates: "16/03, 13/04, 11/05, 08/06" },
    { d: "Segunda", t: "Tarde", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "A", dates: "16/03, 13/04, 11/05, 08/06" },
    { d: "Segunda", t: "Tarde", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "B", dates: "23/02, 23/03, 20/04, 18/05, 15/06" },
    { d: "Segunda", t: "Tarde", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "C", dates: "02/03, 30/03, 27/04, 25/05, 22/06" },
    { d: "Segunda", t: "Tarde", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "D", dates: "09/03, 06/04, 04/05, 01/06" },

    /* TER√áA - COM HOR√ÅRIOS DEFINIDOS */
    { d: "Ter√ßa", t: "Manh√£", act: "HP-8", p: "Kalysta Borges", l: "Aud HRBA", g: "Todos", dates: "Semanal", h: "09:00 - 10:30" },
    { d: "Ter√ßa", t: "Manh√£", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "A", dates: "03/03, 31/03, 28/04, 26/05, 23/06", h: "08:00 - 12:00" },
    { d: "Ter√ßa", t: "Manh√£", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "B", dates: "10/03, 07/04, 05/05, 02/06", h: "08:00 - 12:00" },
    { d: "Ter√ßa", t: "Manh√£", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "C", dates: "17/03, 14/04, 12/05, 09/06", h: "08:00 - 12:00" },
    { d: "Ter√ßa", t: "Manh√£", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "D", dates: "24/02, 24/03, 19/05, 16/06", h: "08:00 - 12:00" },
    
    { d: "Ter√ßa", t: "Tarde", act: "HP-8", p: "Wesley Muniz", l: "UEPA", g: "Todos", dates: "24/02, 10/03, 24/03, 07/04, 28/04, 05/05, 19/05, 09/06, 23/06" },
    { d: "Ter√ßa", t: "Noite", act: "TUTORIAL-8", p: "Wesley Muniz / Marcos Honorato", l: "UEPA", g: "Todos", dates: "Semanal" },

    /* QUARTA */
    { d: "Quarta", t: "Tarde", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "A", dates: "11/03, 08/04, 06/05, 03/06" },
    { d: "Quarta", t: "Tarde", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "B", dates: "18/03, 15/04, 13/05, 10/06" },
    { d: "Quarta", t: "Tarde", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "C", dates: "25/02, 25/03, 22/04, 20/05, 17/06" },
    { d: "Quarta", t: "Tarde", act: "HP-8", p: "Kalysta Borges", l: "HRBA", g: "D", dates: "04/03, 01/04, 29/04, 27/05, 24/06" },
    { d: "Quarta", t: "Tarde", act: "HP-8", p: "Alexandre Neto", l: "UEPA", g: "Todos", dates: "Semanal" },
    { d: "Quarta", t: "Noite", act: "HP-8", p: "Adriana Pires / Paulo Pires", l: "UEPA", g: "Todos", dates: "Semanal" },

    /* QUINTA */
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Wesley Muniz", l: "HMS", g: "A", dates: "26/02, 26/03, 23/04, 21/05, 18/06" },
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Wesley Muniz", l: "HMS", g: "B", dates: "05/03, 02/04, 30/04, 28/05, 25/06" },
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Wesley Muniz", l: "HMS", g: "C", dates: "19/03, 16/04, 14/05, 11/06" },
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Wesley Muniz", l: "HMS", g: "D", dates: "12/03, 09/04, 07/05" },
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Marcos Honorato", l: "UEPA/Amb", g: "B, C", dates: "26/02, 12/03, 26/03, 09/04, 23/04, 07/05, 21/05, 18/06" },
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Marcos Honorato", l: "UEPA/Amb", g: "A, D", dates: "05/03, 19/03, 02/04, 16/04, 30/04, 14/05, 28/05, 11/06, 25/06" },
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Adriana Pires / Paulo Pires", l: "HMS/URES", g: "D", dates: "26/02, 26/03, 23/04, 21/05, 18/06" },
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Adriana Pires / Paulo Pires", l: "HMS/URES", g: "A", dates: "12/03, 09/04, 07/05" },
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Adriana Pires / Paulo Pires", l: "HMS/URES", g: "B", dates: "19/03, 16/04, 14/05, 11/06" },
    { d: "Quinta", t: "Manh√£", act: "HP-8", p: "Adriana Pires / Paulo Pires", l: "HMS/URES", g: "C", dates: "05/03, 02/04, 30/04, 28/05, 25/06" },
    
    { d: "Quinta", t: "Tarde", act: "HP-8", p: "Wesley Muniz", l: "HMS", g: "A", dates: "19/03, 16/04, 14/05, 11/06" },
    { d: "Quinta", t: "Tarde", act: "HP-8", p: "Wesley Muniz", l: "HMS", g: "B", dates: "26/02, 26/03, 23/04, 21/05, 18/06" },
    { d: "Quinta", t: "Tarde", act: "HP-8", p: "Wesley Muniz", l: "HMS", g: "C", dates: "05/03, 02/04, 30/04, 28/05, 25/06" },
    { d: "Quinta", t: "Tarde", act: "HP-8", p: "Wesley Muniz", l: "HMS", g: "D", dates: "12/03, 09/04, 07/05" },
    { d: "Quinta", t: "Tarde", act: "HP-8", p: "Marcos Honorato", l: "HMS", g: "A", dates: "26/02, 26/03, 23/04, 21/05, 18/06" },
    { d: "Quinta", t: "Tarde", act: "HP-8", p: "Marcos Honorato", l: "HMS", g: "B", dates: "12/03, 09/04, 07/05" },
    { d: "Quinta", t: "Tarde", act: "HP-8", p: "Marcos Honorato", l: "HMS", g: "C", dates: "19/03, 16/04, 14/05, 11/06" },
    { d: "Quinta", t: "Tarde", act: "HP-8", p: "Marcos Honorato", l: "HMS", g: "D", dates: "05/03, 02/04, 30/04, 28/05, 25/06" },
    { d: "Quinta", t: "Noite", act: "HP-8/CONF", p: "Marcos Honorato", l: "UEPA", g: "Todos", dates: "Semanal" },

    /* SEXTA */
    { d: "Sexta", t: "Manh√£", act: "MORFO-8", p: "Giovana Gilbert / Carlena Silva / Christian Lima", l: "UEPA", g: "Todos", dates: "Semanal" },
    { d: "Sexta", t: "Noite", act: "TUTORIAL-8", p: "Wesley Muniz / Marcos Honorato", l: "UEPA", g: "Todos", dates: "Semanal" },

    /* S√ÅBADO */
    { d: "S√°bado", t: "Manh√£", act: "HP-8 (Uro)", p: "Wesley Muniz", l: "UEPA UROLOGIA", g: "A", dates: "07/03, 09/05, 20/06" },
    { d: "S√°bado", t: "Manh√£", act: "HP-8 (Uro)", p: "Wesley Muniz", l: "UEPA UROLOGIA", g: "B", dates: "21/03, 16/05" },
    { d: "S√°bado", t: "Manh√£", act: "HP-8 (Uro)", p: "Wesley Muniz", l: "UEPA UROLOGIA", g: "C", dates: "11/04, 29/05" },
    { d: "S√°bado", t: "Manh√£", act: "HP-8 (Uro)", p: "Wesley Muniz", l: "UEPA UROLOGIA", g: "D", dates: "18/04, 13/06" }
];

const GROUP_MEMBERS = {
    A: ["Vanessa S Cruz", "Laura V S Linhares", "Let√≠cia S Rodrigues", "Lena K R Lameira", "Claudemir G Pedroso Jr"],
    B: ["Fernanda L Duarte", "Eduardo F Pallaro", "Let√≠cia T A Costa", "Gustavo S Azevedo", "Andrey B Almeida"],
    C: ["Diego M Rocha", "Jeremias J Souza", "William A Abreu", "Dayvison T Trindade", "Vin√≠cius S Rem√©dios"],
    D: ["Brenda S Lima", "Bruno A Silva", "Frank J Nascimento", "Tiago M Brasil", "Roberta F Menezes", "Maysa C Bastos"]
};

let activeFilter = 'currWeek';

function toggleDarkMode() {
    document.body.classList.toggle('dark-theme');
    localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
}

function toggleHours() { showHours = !showHours; updateView(); }

function toggleSliders() { document.getElementById('sliderDrawer').classList.toggle('active'); }

function abrev(name) {
    if (name === "-" || !name) return "";
    return name.split('/').map(part => {
        const words = part.trim().split(' ');
        if (words.length < 2) return words[0];
        return `${words[0]} ${words[1].charAt(0)}`;
    }).join(' / ');
}

function getLocColorVar(l) {
    const loc = l.toUpperCase();
    if (loc.includes("HMS")) return "var(--c-hms)";
    if (loc.includes("UEPA")) return "var(--c-uepa)";
    if (loc.includes("HRBA")) return "var(--c-hrba)";
    if (loc.includes("URES")) return "var(--c-ures)";
    if (loc.includes("UBS")) return "var(--c-ubs)";
    if (loc.includes("AMB")) return "var(--c-amb)";
    return "var(--c-neutral)";
}

function getPillClass(l) {
    const loc = l.toUpperCase();
    if (loc.includes("HMS")) return "pill-hms";
    if (loc.includes("UEPA")) return "pill-uepa";
    if (loc.includes("HRBA")) return "pill-hrba";
    if (loc.includes("URES")) return "pill-ures";
    if (loc.includes("UBS")) return "pill-ubs";
    if (loc.includes("AMB")) return "pill-amb";
    return "pill-neutral";
}

function generateImage() {
    const element = document.getElementById("capture-area");
    document.body.classList.add('capturing');
    var bgCor = getComputedStyle(document.body).getPropertyValue('--card-bg').trim();
    html2canvas(element, { backgroundColor: bgCor, scale: 2 }).then(canvas => {
        document.body.classList.remove('capturing');
        const link = document.createElement('a');
        link.download = `Cronograma_MED8.png`;
        link.href = canvas.toDataURL(); link.click();
    });
}

function checkWeek(dateStr, offset) {
    const now = new Date(); 
    const currentDay = now.getDay();
    const dayAdjusted = currentDay === 0 ? 7 : currentDay;
    const diff = now.getDate() - (dayAdjusted - 1) + (offset * 7);
    const start = new Date(now.setDate(diff)); start.setHours(0,0,0,0);
    const end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59);
    return dateStr.split(',').some(d => {
        const parts = d.trim().split('/');
        if (parts.length < 2) return false;
        const [dayPart, monthPart] = parts.map(Number);
        const classDate = new Date(ANO_LETIVO, monthPart - 1, dayPart);
        return classDate >= start && classDate <= end;
    });
}

function updateView() {
    const group = document.getElementById('groupSelect').value;
    localStorage.setItem('medGroup', group);
    const days = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
    const turns = ["Manh√£", "Tarde", "Noite"];
    const sorted = [...GROUP_MEMBERS[group]].sort();
    document.getElementById('membersDisplay').innerHTML = `üìç <b>Integrantes:</b> ${sorted.map(m => abrev(m)).join(', ')}`;
    document.getElementById('tableTitle').innerText = `MED8 | GRUPO ${group} | ${ANO_LETIVO}.1`;
    
    let todayIndex = new Date().getDay();
    if (todayIndex === 0) todayIndex = 7;
    const isCurrentWeekMode = activeFilter === 'currWeek';
    
    let html = "";
    turns.forEach(turn => {
        html += `<tr><td class="time-col">${turn[0]}</td>`;
        days.forEach((day, index) => {
            const matches = DATA_LEGO.filter(item => {
                const groupMatch = item.g === "Todos" || item.g.includes(group);
                return item.d === day && item.t === turn && groupMatch;
            });
            const highlightClass = (isCurrentWeekMode && (index + 1) === todayIndex) ? 'today-column' : '';
            let cellContent = "";
            matches.forEach(m => {
                let show = (activeFilter === 'all' || m.dates === "Semanal");
                let filteredDates = m.dates;
                if (!show) {
                    if (activeFilter.includes('/')) {
                        const dateArr = m.dates.split(',').filter(d => d.includes(activeFilter));
                        if (dateArr.length > 0) { show = true; filteredDates = dateArr.join(', '); }
                    } else if (activeFilter === 'currWeek') { show = checkWeek(m.dates, 0); }
                    else if (activeFilter === 'nextWeek') { show = checkWeek(m.dates, 1); }
                }
                if (show) {
                    const actL = m.act.toLowerCase();
                    let colorClass = "";
                    if(actL.includes("giesc")) colorClass = "giesc";
                    else if(actL.includes("hp-8")) colorClass = "hp8";
                    else if(actL.includes("tutorial")) colorClass = "tutorial";
                    else if(actL.includes("morfo")) colorClass = "morfo";

                    let displayTitle = abrev(m.p); 
                    if (m.act.includes("TUTORIAL") || m.act.includes("MORFO")) {
                        displayTitle = m.act; 
                    }

                    const locsArr = m.l.split('/');
                    const pills = locsArr.map(loc => `<span class="pill ${getPillClass(loc)}">${loc.trim()}</span>`).join('');
                    const hourBadge = (showHours && m.h) ? `<span class="badge-time">${m.h}</span>` : "";
                    
                    cellContent += `<div class="subject-block ${colorClass}">
                        <div class="card-header">
                            <span class="card-title">${displayTitle}</span>
                            <div style="display:flex; gap:2px">${pills}</div>
                        </div>
                        <div class="date-line">
                            ${m.dates === "Semanal" ? 'Semanal' : filteredDates}
                            ${hourBadge}
                        </div>
                    </div>`;
                }
            });
            html += `<td class="${highlightClass}">${cellContent || "‚Äî"}</td>`;
        });
        html += "</tr>";
    });
    document.getElementById('scheduleBody').innerHTML = html;
    document.querySelectorAll('#header-row th').forEach((th, i) => {
        if(i > 0) th.classList.toggle('today-column', (isCurrentWeekMode && i === todayIndex));
    });
}

function setFilter(val, btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active'); activeFilter = val; updateView();
}

function changeGroup(val) { updateView(); }

(function init() {
    const today = new Date();
    document.getElementById('todayDisplay').innerText = `Hoje: ${today.toLocaleDateString('pt-BR')}`;
    const sel = document.getElementById('groupSelect');
    Object.keys(DATA_LEGO.reduce((acc, curr) => { if(curr.g !== "Todos") curr.g.split(',').forEach(g => acc[g.trim()] = true); return acc; }, {})).sort().forEach(k => sel.add(new Option(`Grupo ${k}`, k)));
    sel.value = localStorage.getItem('medGroup') || 'A';
    if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-theme');
    const months = [{n:'Fev',v:'/02'},{n:'Mar',v:'/03'},{n:'Abr',v:'/04'},{n:'Mai',v:'/05'},{n:'Jun',v:'/06'}];
    document.getElementById('monthButtons').innerHTML = months.map(m => `<button class="filter-btn" onclick="setFilter('${m.v}', this)">${m.n}</button>`).join('');
    document.getElementById('btn-currWeek').classList.add('active');
    updateView();
})();
</script>
</body>
</html>
